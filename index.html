<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Annotator</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- Extension Géoportail pour Leaflet -->
  <script src="https://ignf.github.io/geoportal-extensions/leaflet-latest/dist/GpPluginLeaflet.js"></script>
  <link rel="stylesheet" href="https://ignf.github.io/geoportal-extensions/leaflet-latest/dist/GpPluginLeaflet.css" />
  <!-- Leaflet easy button -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
  <!-- Leaflet Sync -->
  <script src="./L.Map.Sync.js"></script>
  <!-- Bootstrap icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
	<style>
		html, body { height: 100%; margin: 0; }
    #top { position:absolute; text-align: center; width: 720px; bottom: 50%; left:50%;transform: translate(-50%, 0); z-index: 500;}
		#container { height: 100%; width: 100%; }
		.leaflet-container { height: 100%; width: 100%; max-width: 100%; max-height: 100%; }
    #mapLeft, #mapRight { width: 50%; height: 100%; }
    #mapLeft { float: left; }
    #mapRight { float: right; }
    #center { position:absolute; text-align: center; width: 800px; bottom: 200px; left:50%;transform: translate(-50%, 0); z-index: 500;}
    #bottom-center { position:absolute; text-align: center; width: 105px; bottom: 60px;left:50%;transform: translate(-50%, 0); z-index: 500;}
    .my-control { background-color : rgba(255,255,255,0.5); text-align: 'left' ; padding: 5px 5px}
    .top-button {
      top: 40%;
    }
    .middle-button { display: inline-block; position: relative; }
    .bottom-button { display: inline-block; position: relative; }
    .my-button {
      background-color: white;
      z-index: 500;
      margin: 30px;
    }
    .my-button .label {
      visibility: visible;
      width: 100px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px 0;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 1;
      transition: opacity 0.3s;
    }
    .my-button .tooltiptext {
      visibility: hidden;
      width: 120px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px 0;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .my-button:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    .my-button .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #555 transparent transparent transparent;
    }
	</style>
</head>
<body>
  <div id="top" hidden="hidden">
    <label for="token" id="tokenLabel">Please Login with a GitHub TOKEN:</label>
    <input type="password" id="token" title="Paste your token from GitHub">
    <button class="login" id="login">Login</button>
  </div>
  <div id="container">
    <div id="mapLeft" class="map"></div>
    <div id="mapRight" class="map"></div>
    <div id="center" class='center'></div>
    <div id="bottom-center" class='bottom-center'></div>
  </div>
</body>
<script type="module">
  // Login to github with octokit and a github token
  import { Octokit, App } from "https://esm.sh/octokit";
  let login;
  let octokit;
  let files;
  let currentFileIndex;
  // Read the data from github
  async function readJSONFile(filePath) {
    const result = await octokit.request('GET /repos/{owner}/{repo}/contents/{path}', {
      owner: 'subdense',
      repo: 'data',
      path: filePath,
      headers: { 'X-GitHub-Api-Version': '2022-11-28' }
    });
    const text = atob(result.data.content);
    let fileContent = JSON.parse(text), sha = result.data.sha;
    return { fileContent, sha };
  }
  const token = localStorage.getItem("token");
  async function authenticate(token) {
    octokit = new Octokit({ auth: token });
    const { data: { login } } = await octokit.rest.users.getAuthenticated();
    return login;
  }
  let loginBtn = document.querySelector('.login');
  function showLogin() {
    // hide the login informations
    document.getElementById('top').removeAttribute("hidden");
  }
  function hideLogin() {
    // hide the login informations
    document.getElementById('top').setAttribute("hidden", "hidden");
  }
  async function readFileListAndCreateMaps() {
    // Read the files from github
    const jsonFileContent = await readJSONFile('list.json')
    const jsonContent = jsonFileContent.fileContent;
    const dates = jsonContent["dates"];
    const wmts = jsonContent["wmts"];
    files = jsonContent["files"];
    const mapLeft  = L.map('mapLeft', {attributionControl: false});
    const mapRight = L.map('mapRight', { zoomControl: false });
    // Add a label on top right with user login
    let LoginControl = L.Control.extend({
      onAdd: function(map) {
        var div = L.DomUtil.create('div','leaflet-bar my-control');
        div.innerHTML = login;
        return div;
      }
    });
    let myLoginControl = new LoginControl({position: 'bottomleft'}).addTo(mapLeft);
    let DateControlL = L.Control.extend({
      onAdd: function(map) {
        var div = L.DomUtil.create('div','leaflet-bar my-control');
        div.innerHTML = dates[0];
        return div;
      }
    });
    let myDateControlL = new DateControlL().addTo(mapLeft);
    let DateControlR = L.Control.extend({
      onAdd: function(map) {
        var div = L.DomUtil.create('div','leaflet-bar my-control');
        div.innerHTML = dates[1];
        return div;
      }
    });
    let myDateControlR = new DateControlR().addTo(mapRight);
    // Création de la couche
    var lyrLeft = L.geoportalLayer.WMTS({ layer  : wmts[0] },{ maxZoom: 20, maxNativeZoom: 18 });
    var lyrRight = L.geoportalLayer.WMTS({ layer  : wmts[1] },{ maxZoom: 20, maxNativeZoom: 18 });
    lyrLeft.addTo(mapLeft);
    lyrRight.addTo(mapRight);
    const ZoomViewer = L.Control.extend({
      onAdd() {
        const gauge = L.DomUtil.create('div','leaflet-bar my-control');
        mapRight.on('zoomstart zoom zoomend', (ev) => { gauge.innerHTML = `Zoom level: ${mapRight.getZoom()}`; });
        return gauge;
      }
    });
    const zoomViewer = (new ZoomViewer({position: 'bottomleft'})).addTo(mapRight);
    // Read the next file from github
    async function readNextJSONFile() {
      if (currentFileIndex === undefined) { currentFileIndex = 0; } else { currentFileIndex = (currentFileIndex + 1)%files.length; }
      return readJSONFile(`data_${currentFileIndex}.geojson`);
    }
    let leftRightStyle = {
      "color": "#ff7800",
      "weight": 5,
      "opacity": 0.25,
      "dashArray": "20 20",
      "dashOffset": "10",
      "fill": false
    };
    let leftLeftStyle = {
      "color": "#78ff00",
      "weight": 2,
      "opacity": 0.8,
      "fill": false
    };
    let rightRightStyle = {
      "color": "#ff7800",
      "weight": 2,
      "opacity": 0.8,
      "fill": false
    };
    let rightLeftStyle = {
      "color": "#78ff00",
      "weight": 5,
      "opacity": 0.25,
      "dashArray": "20 20",
      "dashOffset": "10",
      "fill": false
    };
    let {fileContent,sha} = await readNextJSONFile();
    while (fileContent[login]) {
      let content = await readNextJSONFile();
      fileContent = content.fileContent;
      sha = content.sha;
    }
    let geoJSONLeft = L.geoJSON(fileContent, { filter: function(feature, layer) { return feature.properties.date == dates[0]; }, style: leftLeftStyle });
    let geoJSONLeftRight = L.geoJSON(fileContent, { filter: function(feature, layer) { return feature.properties.date == dates[1]; }, style: leftRightStyle });
    let geoJSONRight = L.geoJSON(fileContent, { filter: function(feature, layer) { return feature.properties.date == dates[1]; }, style: rightRightStyle });
    let geoJSONRightLeft = L.geoJSON(fileContent, { filter: function(feature, layer) { return feature.properties.date == dates[0]; }, style: rightLeftStyle });
    geoJSONLeft.addTo(mapLeft);
    geoJSONLeftRight.addTo(mapLeft);
    geoJSONRight.addTo(mapRight);
    geoJSONRightLeft.addTo(mapRight);
    mapLeft.setView(geoJSONRight.getBounds().getCenter(), 18);
    mapLeft.sync(mapRight);
    mapRight.sync(mapLeft);
    var newValue = fileContent[login];
    async function nextJSONFile() {
      let nextFileContent = await readNextJSONFile();
      fileContent = nextFileContent.fileContent;
      sha = nextFileContent.sha;
      // remove previous geojsons
      geoJSONLeft.remove();
      geoJSONLeftRight.remove();
      geoJSONRight.remove();
      geoJSONRightLeft.remove();
      // add new geojsons
      geoJSONLeft = L.geoJSON(fileContent, { filter: function(feature, layer) { return feature.properties.date == dates[0]; }, style: leftLeftStyle });
      geoJSONLeftRight = L.geoJSON(fileContent, { filter: function(feature, layer) { return feature.properties.date == dates[1]; }, style: leftRightStyle });
      geoJSONRight = L.geoJSON(fileContent, { filter: function(feature, layer) { return feature.properties.date == dates[1]; }, style: rightRightStyle });
      geoJSONRightLeft = L.geoJSON(fileContent, { filter: function(feature, layer) { return feature.properties.date == dates[0]; }, style: rightLeftStyle });
      geoJSONLeft.addTo(mapLeft);
      geoJSONLeftRight.addTo(mapLeft);
      geoJSONRight.addTo(mapRight);
      geoJSONRightLeft.addTo(mapRight);
      // update view
      mapLeft.setView(geoJSONRight.getBounds().getCenter(), 18);
      // update buttons
      newValue = fileContent[login];
      if (newValue) {
        // console.log("Value defined for ",login," = ", newValue);
        for (const [aKey, aButton] of Object.entries(buttonDict)) {
          if (aKey == newValue) aButton.classList.add("disabled");
          else aButton.classList.remove("disabled");
        };
      } else {
        newValue = "none";
        // console.log(sha);
        for (const [aKey, aButton] of Object.entries(buttonDict)) {
          aButton.classList.remove("disabled");
        };
      }
    }
    function addButtonInContainer(image, name, container, position) {
      const button = L.DomUtil.create('button',`leaflet-bar my-button leaflet-interactive ${position}`);
      const img = L.DomUtil.create('img','',button);
      img.src=image;
      img.width=30;
      img.height=30;
      const span = L.DomUtil.create('span','label',button);
      span.innerHTML=name;
      document.getElementById(container).appendChild(button);
      return button;
    };
    let saveBtn = addButtonInContainer("save.svg", "Save", 'bottom-center', 'bottom-button');
    saveBtn.onclick = async function() {
      fileContent[login] = newValue;
      const theContent = btoa(JSON.stringify(fileContent, undefined, 2));
      await octokit.request('PUT /repos/{owner}/{repo}/contents/{path}', {
        owner: 'subdense',
        repo: 'data',
        path: `data_${currentFileIndex}.geojson`,
        message: 'Data updated from annotator',
        content: theContent,
        sha: sha,
        headers: { 'X-GitHub-Api-Version': '2022-11-28' }
      });
      console.log("all done!");
      nextJSONFile();
    }; 
    // let nextBtn = addButtonInContainer("next.svg", "Next", 'bottom-center', 'bottom-button');
    // nextBtn.onclick = async function() {
    //   let nextFileContent = await readNextJSONFile();
    //   fileContent = nextFileContent.fileContent;
    //   sha = nextFileContent.sha;
    //   // remove previous geojsons
    //   geoJSONLeft.remove();
    //   geoJSONRight.remove();
    //   // add new geojsons
    //   geoJSONLeft = L.geoJSON(fileContent, { filter: function(feature, layer) { return feature.properties.date == dates[0]; } });
    //   geoJSONRight = L.geoJSON(fileContent, { filter: function(feature, layer) { return feature.properties.date == dates[1]; } });
    //   geoJSONLeft.addTo(mapLeft);
    //   geoJSONRight.addTo(mapRight);
    //   // update view
    //   mapLeft.setView(geoJSONRight.getBounds().getCenter(), 18);
    //   // update buttons
    //   newValue = fileContent[login];
    //   if (newValue) {
    //     // console.log("Value defined for ",login," = ", newValue);
    //     for (const [aKey, aButton] of Object.entries(buttonDict)) {
    //       if (aKey == newValue) aButton.classList.add("disabled");
    //       else aButton.classList.remove("disabled");
    //     };
    //   } else {
    //     newValue = "none";
    //     // console.log(sha);
    //     for (const [aKey, aButton] of Object.entries(buttonDict)) {
    //       aButton.classList.remove("disabled");
    //     };
    //   }
    // };
    const buttonNames = [
      ["creation.svg","Creation"],
      ["destruction.svg","Destruction"],
      ["merge.svg","Merge"],
      ["stable.svg","Stable"],
      ["split.svg","Split"],
      ["reallocation.svg","Reallocation"],
      ["skip.svg","Skip"]
      // ["specification.svg","Specification Change"]
    ];
    var buttonDict = [];
    buttonNames.forEach(addButton);
    function addButton(value, index, array) {
      const button = L.DomUtil.create('button','leaflet-bar my-button middle-button leaflet-interactive');
      const img = L.DomUtil.create('img','',button);
      img.src=value[0];
      img.width=30;
      img.height=30;
      const span = L.DomUtil.create('span','label',button);
      span.innerHTML=value[1];
      button.onclick = function(){
        newValue=value[1];
        for (const [aKey, aButton] of Object.entries(buttonDict)) { aButton.classList.remove("disabled"); };
        button.classList.add("disabled");
      }; 
      document.getElementById('center').appendChild(button);
      buttonDict[value[1]] = button;
    }
    if (newValue) {
      for (const [aKey, aButton] of Object.entries(buttonDict)) {
        if (aKey == newValue) aButton.classList.add("disabled");
        else aButton.classList.remove("disabled");
      };
    } else {
      newValue = "none";
      for (const [aKey, aButton] of Object.entries(buttonDict)) {
        aButton.classList.remove("disabled");
      };
    }
  }
  if (token) {
    login = await authenticate(token);
    console.log("token found. Logged in as:", login);
    await readFileListAndCreateMaps();
  } else {
    showLogin();
  }
  loginBtn.addEventListener('click', async () => {
    const token = document.getElementById("token").value;
    login = await authenticate(token);
    hideLogin();
    // save token in local storage (browser)
    localStorage.setItem("token", token);
    await readFileListAndCreateMaps();
  });
</script>
</html>
