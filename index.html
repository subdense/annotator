<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>title</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- Extension Géoportail pour Leaflet -->
  <script src="http://ignf.github.io/geoportal-extensions/leaflet-latest/dist/GpPluginLeaflet.js"></script>
  <link rel="stylesheet" href="http://ignf.github.io/geoportal-extensions/leaflet-latest/dist/GpPluginLeaflet.css" />
  <!-- Leaflet easy button-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
  <!-- Leaflet Sync-->
  <script src="./L.Map.Sync.js"></script>
	<style>
		html, body { height: 100%; margin: 0; }
		.leaflet-container {
			height: 100%;
			width: 100%;
			max-width: 100%;
			max-height: 100%;
		}
    #mapLeft, #mapRight { width: 50%; height: 100%; }
    #mapLeft { float: left; }
    #mapRight { float: right; }
    .red { color: red; }
    .green { color: green; }
    .my-control { background-color : white; }
	</style>
</head>
<body>
  <div id="top">
    <label for="token" id="tokenLabel">GitHub TOKEN:</label>
    <input type="password" id="token" title="Paste your token from GitHub">
    <button class="login" id="login">Login</button>
  </div>
  <div id="mapLeft" class="map"></div>
  <div id="mapRight" class="map"></div>
</body>
<script type="module">
  // Login to github with octokit and a github token
  import { Octokit, App } from "https://esm.sh/octokit";
  let octokit;
  let loginBtn = document.querySelector('.login');
  loginBtn.addEventListener('click', async () => {
    octokit = new Octokit({ auth: document.getElementById("token").value });
    const { data: { login } } = await octokit.rest.users.getAuthenticated();
    console.log("Hello, %s", login);
    // hide the login informations
    document.getElementById('tokenLabel').setAttribute("hidden", "hidden");
    document.getElementById('token').setAttribute("hidden", "hidden");
    loginBtn.style.display = 'none';
    // Read the data from github
    const result = await octokit.request('GET /repos/{owner}/{repo}/contents/{path}', {
      owner: 'julienperret',
      repo: 'hello-world',
      path: 'map.geojson',
      headers: { 'X-GitHub-Api-Version': '2022-11-28' }
    });
    const text = atob(result.data.content);
    const jsonContent = JSON.parse(text);
    const dates = jsonContent["dates"];
    const wmts = jsonContent["wmts"];
    const mapLeft  = L.map('mapLeft');
    const mapRight = L.map('mapRight');
    // Add a label on top right with user login
    // let LoginControl = L.Control.extend({
    //   onAdd: function(map) {
    //       var div = L.DomUtil.create('div','leaflet-bar my-control');
    //       div.innerHTML = login;
    //       return div;
    //   },
    //   onRemove: function(map) {}
    // });
    // let myLoginControl = new LoginControl().addTo(mapLeft);
    let DateControlL = L.Control.extend({
      onAdd: function(map) {
          var div = L.DomUtil.create('div','leaflet-bar my-control');
          div.innerHTML = dates[0];
          return div;
      },
      onRemove: function(map) {}
    });
    let myDateControlL = new DateControlL().addTo(mapLeft);
    let DateControlR = L.Control.extend({
      onAdd: function(map) {
          var div = L.DomUtil.create('div','leaflet-bar my-control');
          div.innerHTML = dates[1];
          return div;
      },
      onRemove: function(map) {}
    });
    let myDateControlR = new DateControlR().addTo(mapRight);
    // Création de la couche
    var lyrLeft = L.geoportalLayer.WMTS({
        layer  : wmts[0],//"ORTHOIMAGERY.ORTHOPHOTOS2011",
        maxZoom: 18
    });
    var lyrRight = L.geoportalLayer.WMTS({
        layer  : wmts[1],//"ORTHOIMAGERY.ORTHOPHOTOS",
        maxZoom: 18
    });
    lyrLeft.addTo(mapLeft);
    lyrRight.addTo(mapRight);
    const geoJSONLeft = L.geoJSON(jsonContent, { filter: function(feature, layer) { return feature.properties.date == dates[0]; } });
    const geoJSONRight = L.geoJSON(jsonContent, { filter: function(feature, layer) { return feature.properties.date == dates[1]; } });
    geoJSONLeft.addTo(mapLeft);
    geoJSONRight.addTo(mapRight);
    mapLeft.setView(geoJSONRight.getBounds().getCenter(), 18);
    mapLeft.sync(mapRight);
    mapRight.sync(mapLeft);
    let greenBtn;
    let redBtn = L.easyButton( '<span class="red">&FilledSmallSquare;</span>', function(){
      this.disable();
      greenBtn.enable();
      newValue = "red";
    });
    redBtn.addTo(mapLeft);
    greenBtn = L.easyButton( '<span class="green">&FilledSmallSquare;</span>', function(){
      this.disable();
      redBtn.enable();
      newValue = "green";
    });
    greenBtn.addTo(mapLeft);
    var newValue = jsonContent[login];
    if (newValue) {
      console.log("Value defined for ",login," = ", newValue);
      if (newValue == "red") {
        redBtn.disable();
        greenBtn.enable();
      } else if (newValue == "green") {
        redBtn.enable();
        greenBtn.disable();
      }
    } else {
      newValue = "none";
    }
    let saveBtn = L.easyButton('<span class="save">S</span>', async () => {
      console.log("newValue=",newValue);
      jsonContent[login] = newValue
      const theContent = btoa(JSON.stringify(jsonContent));
      await octokit.request('PUT /repos/{owner}/{repo}/contents/{path}', {
        owner: 'subdense',
        repo: 'data',
        path: 'test.geojson',
        message: 'Data updated from annotator',
        content: theContent,
        sha: result.data.sha,
        headers: { 'X-GitHub-Api-Version': '2022-11-28' }
      });
      console.log("all done!");
    });
    saveBtn.addTo(mapLeft);
  });
</script>
</html>